<!doctype html>
<html
  class="light"
  lang="en"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Panel de Aprobación - Compra Amigos</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;family=Noto+Sans:wght@400;500&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
      rel="stylesheet"
    />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#e67e22",
              secondary: "#2c3e50",
              "background-light": "#f8fafc",
              "background-dark": "#0f172a",
              "border-muted": "#e2e8f0",
            },
            fontFamily: {
              display: ["Plus Jakarta Sans", "sans-serif"],
              sans: ["Plus Jakarta Sans", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.375rem",
              lg: "0.5rem",
              xl: "0.75rem",
              "2xl": "1rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style type="text/tailwindcss">
      :root {
        --primary-color: #e67e22;
      }
      /* Size utilities used across templates (width & height) */
      .size-1 {
        width: 0.5rem;
        height: 0.5rem;
      }
      .size-2 {
        width: 0.75rem;
        height: 0.75rem;
      }
      .size-5 {
        width: 1.25rem;
        height: 1.25rem;
      }
      .size-6 {
        width: 1.5rem;
        height: 1.5rem;
      }
      .size-7 {
        width: 1.75rem;
        height: 1.75rem;
      }
      .size-8 {
        width: 2rem;
        height: 2rem;
      }
      .size-10 {
        width: 2.5rem;
        height: 2.5rem;
      }
      .size-16 {
        width: 4rem;
        height: 4rem;
      }
      .size-1,
      .size-2,
      .size-5,
      .size-6,
      .size-7,
      .size-8,
      .size-10,
      .size-16 {
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .status-pill {
        @apply px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border;
      }
      .status-pending {
        @apply bg-amber-50 text-amber-700 border-amber-200;
      }
      .status-denied {
        @apply bg-rose-50 text-rose-700 border-rose-200;
      }
      .status-approved {
        @apply bg-emerald-50 text-emerald-700 border-emerald-200;
      }
      .status-draft {
        @apply bg-slate-100 text-slate-600 border-slate-200;
      }
      th {
        @apply text-left px-4 py-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider border-b border-slate-100;
      }
      td {
        @apply px-4 py-3 text-sm text-slate-600 border-b border-slate-50;
      }
      .btn-action {
        @apply flex items-center justify-center size-8 rounded-lg transition-all border;
      }
      .modal-overlay {
        @apply fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4;
      }
      .form-label {
        @apply block text-[10px] font-bold uppercase tracking-wider text-slate-500 mb-1.5;
      }
      .form-input {
        @apply w-full text-sm border-slate-200 rounded-lg focus:ring-primary focus:border-primary transition-all;
      }
      .active {
        @apply text-primary border-b-2 border-primary;
      }
      .no-active {
        @apply text-slate-500 hover:text-primary transition-colors;
      }
      @keyframes dropdown-enter {
        from {
          opacity: 0;
          transform: translateY(-10px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      .dropdown-enter {
        animation: dropdown-enter 0.2s ease-out forwards;
      }
      .spinner-gradient {
        background: conic-gradient(
          from 0deg,
          transparent 0%,
          var(--primary-color) 100%
        );
        -webkit-mask: radial-gradient(
          farthest-side,
          transparent calc(100% - 6px),
          #000 0
        );
        mask: radial-gradient(
          farthest-side,
          transparent calc(100% - 6px),
          #000 0
        );
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      @keyframes modal-pop-in {
        0% {
          opacity: 0;
          transform: translateY(10px) scale(0.98);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      .animate-pop-in {
        animation: modal-pop-in 0.26s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }

      @keyframes overlay-fade {
        0% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }
      .animate-overlay {
        animation: overlay-fade 0.18s ease-out forwards;
      }
      /* Mobile: allow modal content to scroll when it exceeds viewport height */
      @media (max-width: 640px) {
        .modal-overlay {
          align-items: flex-start;
          padding-top: 1rem;
          padding-bottom: 1rem;
          /* On small screens treat overlay as interactive and fixed to viewport */
          pointer-events: auto;
          background: transparent; /* visual dim supplied by pseudo-element */
        }
        /* Keep modal content natural height and allow the page to scroll instead */
        #createProductModalContent {
          max-height: none;
          overflow: visible;
          -webkit-overflow-scrolling: auto;
          /* make modal look better on small screens */
          margin: 0.5rem;
          border-radius: 0.75rem;
          box-shadow: 0 10px 30px rgba(2, 6, 23, 0.2);
          pointer-events: auto; /* allow interaction with modal content */
          position: relative;
          z-index: 50; /* ensure it's above the overlay dim */
        }
        .modal-overlay::before {
          content: "";
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.45);
          backdrop-filter: blur(6px);
          pointer-events: auto;
          z-index: 48; /* place dim above page but below modal content */
        }
      }
    </style>
  </head>

  <body
    class="bg-background-light dark:bg-background-dark font-sans text-slate-900 dark:text-[#f8f7f5] antialiased"
  >
    <div class="min-h-screen flex flex-col">
      <header
        class="flex items-center justify-between px-4 py-2 border-b border-slate-200 bg-white sticky top-0 z-50 shadow-sm"
      >
        <div class="flex items-center gap-6">
          <div class="flex items-center gap-2">
            <div
              class="size-7 bg-primary rounded flex items-center justify-center text-white"
            >
              <span class="material-symbols-outlined text-lg font-bold"
                >handshake</span
              >
            </div>
            <div class="flex flex-col">
              <h2 class="text-slate-900 text-sm font-extrabold leading-none">
                Compra Amigos
              </h2>
              <span
                class="text-[8px] uppercase tracking-widest font-bold text-primary/80"
                >Empresa</span
              >
            </div>
          </div>
          <nav class="flex items-center gap-4">
            <a
              sec:authorize="hasAnyRole('SOLICITANTE','VALIDATOR')"
              class="nav-link text-[11px] font-bold uppercase tracking-wider pb-2 mt-2"
              href="/dashboard"
              data-path="/dashboard"
              >Tablero</a
            >
            <a
              sec:authorize="hasRole('SOLICITANTE')"
              class="nav-link text-[11px] font-bold uppercase tracking-wider pb-2 mt-2"
              href="/history"
              data-path="/history"
              >Historial de Aprobación</a
            >
          </nav>
        </div>
        <div class="flex items-center gap-4">
          <div
            id="userMenuWrapper"
            class="relative flex items-center gap-2 px-2 py-1 bg-slate-50 rounded border border-slate-100 cursor-pointer"
          >
            <div
              id="userAvatar"
              role="button"
              tabindex="0"
              aria-haspopup="true"
              aria-controls="userMenu"
              aria-expanded="false"
              class="size-6 rounded-full bg-slate-200 overflow-hidden focus:outline-none"
            >
              <img
                alt="User profile"
                class="w-full h-full object-cover"
                src="https://lh3.googleusercontent.com/aida-public/AB6AXuA9282gWLnaqGN2n8QXABgTX7mDU9xyzviH4TS4l10d6rXvrgdr7XaG-blt7J_QZI3K_nTHgqD4XtjtGt2UPEfk2QHZqevj-OdoREZM8XBf-7vl0Rvp473NhY6iw8Z2fCn5_KLrE__j0icsuzo40Sdpr48rTc0DdBDmy2weNnVUgJT2b7-QlEmyfY1SDjHnxc_mmxl-UkDkndVg0mODQQvLZ3vUEywepX0tcK1jxNRttD1AmYR4dzoy3yeZpfYU_OkKCmC78VgxwFo"
              />
            </div>
            <div
              id="userMenuToggle"
              class="hidden sm:flex flex-col cursor-pointer"
              role="button"
              tabindex="0"
            >
              <span
                class="text-[10px] font-bold text-slate-700 leading-none"
                sec:authentication="principal.fullName"
                >Usuario</span
              >
              <span class="text-[8px] text-slate-400 font-bold uppercase">
                <span sec:authorize="hasRole('VALIDATOR')">Validador</span>
                <span sec:authorize="hasRole('SOLICITANTE')">Solicitante</span>
                <span sec:authorize="!hasAnyRole('VALIDATOR','SOLICITANTE')"
                  >Usuario</span
                >
              </span>
            </div>
            <button
              id="userMenuButton"
              aria-haspopup="true"
              aria-expanded="false"
              class="flex items-center text-slate-400 hover:text-slate-600 focus:outline-none"
            >
              <span class="material-symbols-outlined text-slate-400 text-sm"
                >expand_more</span
              >
            </button>

            <div
              id="userMenu"
              class="hidden absolute top-full right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50"
            >
              <div class="px-4 py-3 border-b block sm:hidden">
                <div
                  class="font-bold text-slate-800"
                  sec:authentication="principal.fullName"
                >
                  Usuario
                </div>
                <div class="text-xs text-slate-500 uppercase font-bold mt-1">
                  <span sec:authorize="hasRole('VALIDATOR')">Validador</span>
                  <span sec:authorize="hasRole('SOLICITANTE')"
                    >Solicitante</span
                  >
                  <span sec:authorize="!hasAnyRole('VALIDATOR','SOLICITANTE')"
                    >Usuario</span
                  >
                </div>
              </div>
              <div
                class="py-1"
                role="menu"
                aria-orientation="vertical"
                aria-labelledby="userMenuButton"
              >
                <a
                  href="/profile"
                  class="flex items-center gap-3 px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 transition-colors"
                  role="menuitem"
                >
                  <span class="material-symbols-outlined text-lg">person</span>
                  <span>Perfil</span>
                </a>
                <a
                  href="/settings"
                  class="flex items-center gap-3 px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 transition-colors"
                  role="menuitem"
                >
                  <span class="material-symbols-outlined text-lg">settings</span>
                  <span>Configuración</span>
                </a>
                <div class="border-t border-slate-100 my-1"></div>
                <form th:action="@{/logout}" method="post" class="m-0">
                  <input
                    th:if="${_csrfParameterName != null}"
                    type="hidden"
                    th:name="${_csrfParameterName}"
                    th:value="${_csrfToken}"
                  />
                  <button
                    type="submit"
                    class="w-full flex items-center gap-3 text-left px-4 py-2 text-sm text-rose-600 hover:bg-rose-50 transition-colors"
                    role="menuitem"
                  >
                    <span class="material-symbols-outlined text-lg">close</span>
                    <span>Cerrar sesión</span>
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </header>
      <main class="flex-1 p-4 max-w-7xl mx-auto w-full space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div
            class="bg-white p-4 rounded-lg border border-slate-200 flex items-center gap-4 shadow-sm"
          >
            <div
              class="size-10 rounded-lg bg-amber-50 text-amber-600 flex items-center justify-center"
            >
              <span class="material-symbols-outlined text-2xl"
                >pending_actions</span
              >
            </div>
            <div>
              <p
                class="text-[10px] font-bold text-slate-500 uppercase tracking-wider"
              >
                Pendientes para mi aprobación
              </p>
              <p
                class="text-2xl font-extrabold text-slate-900 leading-none"
                th:text="${pendingCount}"
              >
                0
              </p>
            </div>
          </div>
          <div
            class="bg-white p-4 rounded-lg border border-slate-200 flex items-center gap-4 shadow-sm"
          >
            <div
              class="size-10 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center"
            >
              <span class="material-symbols-outlined text-2xl">verified</span>
            </div>
            <div>
              <p
                class="text-[10px] font-bold text-slate-500 uppercase tracking-wider"
              >
                Recientemente aprobadas
              </p>
              <p class="text-2xl font-extrabold text-slate-900 leading-none">
                124
              </p>
            </div>
          </div>
          <div
            class="bg-white p-4 rounded-lg border border-slate-200 flex items-center gap-4 shadow-sm"
          >
            <div
              class="size-10 rounded-lg bg-primary/10 text-primary flex items-center justify-center"
            >
              <span class="material-symbols-outlined text-2xl"
                >account_balance_wallet</span
              >
            </div>
            <div>
              <p
                class="text-[10px] font-bold text-slate-500 uppercase tracking-wider"
              >
                Presupuesto total gestionado
              </p>
              <p class="text-2xl font-extrabold text-slate-900 leading-none">
                $285.5k
              </p>
            </div>
          </div>
        </div>
        <div
          class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden"
        >
          <div
            class="px-4 py-3 border-b border-slate-100 flex items-center justify-between bg-slate-50/30"
          >
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-slate-400 text-lg"
                >list_alt</span
              >
              <h3
                class="text-xs font-extrabold text-slate-900 uppercase tracking-tight"
              >
                Cola de aprobaciones pendientes
              </h3>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
              <div class="relative">
                <span
                  class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-slate-400 text-sm"
                  >search</span
                >
                <input
                  class="text-[11px] pl-7 pr-3 py-1 bg-white border-slate-200 rounded w-full sm:w-64 focus:ring-1 focus:ring-primary/20 focus:border-primary outline-none"
                  placeholder="Buscar por solicitante o ID..."
                  type="text"
                />
              </div>
              <button
                class="flex items-center gap-1 text-[11px] font-bold text-slate-500 hover:text-slate-700 bg-white border border-slate-200 px-2 py-1 rounded"
              >
                <span class="material-symbols-outlined text-sm">sort</span>
                Prioridad
              </button>
              <button
                sec:authorize="hasRole('SOLICITANTE')"
                id="openCreateProductModal"
                class="ml-3 bg-primary text-white px-2 sm:px-3 py-1 rounded-lg font-semibold hover:opacity-90 transition-colors flex items-center gap-2"
                aria-haspopup="dialog"
                aria-controls="createProductModal"
                type="button"
              >
                <span class="material-symbols-outlined">add</span>
                <span class="hidden sm:inline">Nuevo producto</span>
              </button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full border-collapse">
              <thead>
                <tr class="bg-slate-50/50">
                  <th sec:authorize="hasRole('VALIDATOR')">ID de solicitud</th>
                  <th sec:authorize="hasRole('SOLICITANTE')">ID</th>
                  <th sec:authorize="hasRole('VALIDATOR')">Solicitante</th>
                  <th sec:authorize="hasRole('SOLICITANTE')">Validador</th>
                  <th>Monto</th>
                  <th>Estatus</th>
                  <th class="text-center">Detalles</th>
                  <th class="text-right px-6">Acción</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-50">
                <tr
                  th:if="${products.isEmpty()}"
                  class="hover:bg-slate-50/50 transition-colors"
                >
                  <td colspan="3" class="text-center py-8">
                    <div class="flex flex-col items-center gap-2">
                      <span
                        class="material-symbols-outlined text-slate-300 text-4xl"
                        >inventory_2</span
                      >
                      <p class="text-sm text-slate-400 font-semibold">
                        No hay productos disponibles
                      </p>
                    </div>
                  </td>
                </tr>
                <tr
                  th:each="product : ${products}"
                  class="hover:bg-slate-50/50 transition-colors"
                >
                  <td
                    sec:authorize="hasRole('VALIDATOR')"
                    class="font-bold text-slate-900"
                    th:text="'#SL-' + ${product.id}"
                  >
                    #1
                  </td>
                  <td
                    sec:authorize="hasRole('SOLICITANTE')"
                    class="font-bold text-slate-900"
                    th:text="'#-' + ${product.id}"
                  >
                    #1
                  </td>

                  <td sec:authorize="hasRole('SOLICITANTE')">
                    <div class="flex items-center gap-2">
                      <div
                        class="size-6 rounded-full bg-slate-100 overflow-hidden"
                      >
                        <img
                          alt="User"
                          src="https://lh3.googleusercontent.com/aida-public/AB6AXuDDpw55y6IInmLG61U0JZ1qfgn6vaj0W6kKt_71VEbZOiK_AT868Dvsjm4_VscETn_Lx4Z8l7D4lWUSh5vwkdhRGgZtjmF6TAAUSE3XrephQIohew0QPWzQ5ezJlM4P3-iuY-3XgUF7dhYShVIc1fbISvc4ZPb32k7A7sxUO_MM2xy3vfcoEHtopd7-Eo4vYO3SZRC-Z3oILrHZWqfCtn2DrbqsgVso5OjwGAajPjyZaaikZtt7477sVYXB2oyfrnneqp2peuzkfaQ"
                        />
                      </div>
                      <span
                        class="font-semibold text-slate-700"
                        th:text="${product.validator != null ? product.validator.name : 'Validador'}"
                        >Validador</span
                      >
                    </div>
                  </td>

                  <td sec:authorize="hasRole('VALIDATOR')">
                    <div class="flex items-center gap-2">
                      <div
                        class="size-6 rounded-full bg-slate-100 overflow-hidden"
                      >
                        <img
                          alt="User"
                          src="https://lh3.googleusercontent.com/aida-public/AB6AXuDDpw55y6IInmLG61U0JZ1qfgn6vaj0W6kKt_71VEbZOiK_AT868Dvsjm4_VscETn_Lx4Z8l7D4lWUSh5vwkdhRGgZtjmF6TAAUSE3XrephQIohew0QPWzQ5ezJlM4P3-iuY-3XgUF7dhYShVIc1fbISvc4ZPb32k7A7sxUO_MM2xy3vfcoEHtopd7-Eo4vYO3SZRC-Z3oILrHZWqfCtn2DrbqsgVso5OjwGAajPjyZaaikZtt7477sVYXB2oyfrnneqp2peuzkfaQ"
                        />
                      </div>
                      <span
                        class="font-semibold text-slate-700"
                        th:text="${product.creator != null ? product.creator.name : 'Solicitante'}"
                        >Solicitante</span
                      >
                    </div>
                  </td>

                  <td
                    class="font-extrabold text-slate-900"
                    th:text="${product.price}"
                  >
                    price
                  </td>
                  <td class="font-extrabold text-slate-900">
                    <span th:switch="${product.status}">
                      <span
                        th:case="1"
                        class="status-pill status-pending"
                        th:text="'Pendiente'"
                        >Pendiente</span
                      >
                      <span
                        th:case="2"
                        class="status-pill status-approved"
                        th:text="'Aprobado'"
                        >Aprobado</span
                      >
                      <span
                        th:case="*"
                        class="status-pill status-rejected"
                        th:text="${product.status}"
                        >Desconocido</span
                      >
                    </span>
                  </td>
                  <td class="text-center">
                    <button class="text-slate-400 hover:text-primary">
                      <span class="material-symbols-outlined text-lg"
                        >visibility</span
                      >
                    </button>
                  </td>
                  <td class="text-right px-6">
                    <div class="flex items-center justify-end gap-2">
                      <button
                        class="btn-action bg-rose-50 border-rose-100 text-rose-600 hover:bg-rose-600 hover:text-white group"
                        title="Reject"
                      >
                        <span class="material-symbols-outlined text-sm"
                          >close</span
                        >
                      </button>
                      <form th:action="@{/product/{id}/approve(id=${product.id})}" method="post" class="m-0"
                            sec:authorize="hasRole('VALIDATOR')">
                        <input th:if="${_csrfParameterName != null}" type="hidden" th:name="${_csrfParameterName}"
                               th:value="${_csrfToken}" />
                        <button type="submit" class="btn-action bg-emerald-50 border-emerald-100 text-emerald-600 hover:bg-emerald-600 hover:text-white"
                                title="Approve">
                            <span class="material-symbols-outlined text-sm font-bold">check</span>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div
            class="px-4 py-2 bg-slate-50 border-t border-slate-100 flex items-center justify-between text-[10px] font-bold text-slate-400 uppercase tracking-widest"
          >
            <span
              sec:authorize="hasRole('VALIDATOR')"
              th:text="${pendingCount} + ' solicitudes a la espera de tu revisión'"
              >0 solicitudes a la espera de tu revisión</span
            >
            <span
              sec:authorize="hasRole('SOLICITANTE')"
              th:text="${pendingCount} + ' solicitudes pendientes'"
              >0 solicitudes pendientes</span
            >

            <div class="flex items-center gap-4">
              <button
                class="hover:text-primary disabled:opacity-30"
                disabled=""
              >
                Anterior
              </button>
              <button class="hover:text-primary">Siguiente</button>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div
            class="lg:col-span-2 bg-white rounded-lg border border-slate-200 p-4 shadow-sm"
          >
            <h4
              class="text-xs font-extrabold text-slate-900 uppercase tracking-tight mb-4 flex items-center gap-2"
            >
              <span class="material-symbols-outlined text-emerald-500 text-lg"
                >history</span
              >
              Historial de actividad reciente
            </h4>
            <div class="space-y-3">
              <div
                class="flex items-center justify-between py-2 border-b border-slate-50"
              >
                <div class="flex items-center gap-3">
                  <div
                    class="size-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center"
                  >
                    <span class="material-symbols-outlined text-sm"
                      >done_all</span
                    >
                  </div>
                  <div>
                    <p class="text-[11px] font-bold text-slate-800">
                      Aprobado #PR-8821 Expansión de servidores en la nube
                    </p>
                    <p class="text-[9px] text-slate-400 uppercase font-bold">
                      Oct 24, 2024 • Solicitante: John Doe
                    </p>
                  </div>
                </div>
                <span class="text-xs font-bold text-slate-900">$1,250.00</span>
              </div>
              <div
                class="flex items-center justify-between py-2 border-b border-slate-50"
              >
                <div class="flex items-center gap-3">
                  <div
                    class="size-8 rounded-full bg-rose-100 text-rose-600 flex items-center justify-center"
                  >
                    <span class="material-symbols-outlined text-sm">close</span>
                  </div>
                  <div>
                    <p class="text-[11px] font-bold text-slate-800">
                      Rejected #PR-8815 Software Upgrade
                    </p>
                    <p class="text-[9px] text-slate-400 uppercase font-bold">
                      Oct 23, 2024 • Requester: Sam Lee
                    </p>
                  </div>
                </div>
                <span class="text-xs font-bold text-slate-900">$4,500.00</span>
              </div>
            </div>
            <button
              class="w-full mt-4 py-2 text-[10px] font-bold text-slate-500 hover:text-primary border-t border-slate-50 uppercase tracking-widest transition-colors"
            >
              Ver registros completos de aprobaciones
            </button>
          </div>
          <div
            class="bg-white rounded-lg border border-slate-200 p-4 shadow-sm"
          >
            <h4
              class="text-xs font-extrabold text-slate-900 uppercase tracking-tight mb-4 flex items-center gap-2"
            >
              <span class="material-symbols-outlined text-primary text-lg"
                >pie_chart</span
              >
              Utilización del presupuesto
            </h4>
            <div class="space-y-4">
              <div>
                <div
                  class="flex justify-between text-[10px] font-bold uppercase mb-1"
                >
                  <span class="text-slate-500">IT Infrastructure</span>
                  <span class="text-slate-900">75%</span>
                </div>
                <div
                  class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden"
                >
                  <div class="h-full bg-primary w-3/4"></div>
                </div>
              </div>
              <div>
                <div
                  class="flex justify-between text-[10px] font-bold uppercase mb-1"
                >
                  <span class="text-slate-500">Marketing</span>
                  <span class="text-slate-900">42%</span>
                </div>
                <div
                  class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden"
                >
                  <div class="h-full bg-secondary w-[42%]"></div>
                </div>
              </div>
              <div>
                <div
                  class="flex justify-between text-[10px] font-bold uppercase mb-1"
                >
                  <span class="text-slate-500">Operations</span>
                  <span class="text-slate-900">18%</span>
                </div>
                <div
                  class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden"
                >
                  <div class="h-full bg-emerald-500 w-[18%]"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
      <footer
        class="flex items-center justify-between px-6 py-3 text-[9px] font-bold uppercase tracking-widest text-slate-400 border-t border-slate-200 bg-white"
      >
        <div class="flex items-center gap-4">
          <p
            th:text="'© ' + ${T(java.time.Year).now().getValue()} + ' Compra Amigos'"
          ></p>
          <span class="opacity-20">|</span>
          <div class="flex items-center gap-1.5 text-green-600">
            <span class="size-1 bg-green-500 rounded-full"></span>
            Sistema operativo
          </div>
        </div>
        <div class="flex gap-4">
          <a class="hover:text-primary transition-colors" href="#"
            >Revisar políticas</a
          >
          <a class="hover:text-primary transition-colors" href="#">Soporte</a>
          <a class="hover:text-primary transition-colors" href="#"
            >Términos de auditoría</a
          >
        </div>
      </footer>
    </div>
    <div th:replace="~{loading :: loading}"></div>
    <div th:if="${savedProductId != null}" th:replace="~{fragments/alert :: savedOverlay(productId=${savedProductId})}"></div>
    <!-- Create Product Modal (hidden by default) -->
    <div
      id="createProductModal"
      class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 px-4"
      style="display: none"
    >
      <div
        id="createProductModalContent"
        class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden"
      >
        <div
          class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50"
        >
          <div class="flex items-center gap-3">
            <div
              class="size-9 bg-primary/10 text-primary rounded-lg flex items-center justify-center"
            >
              <span class="material-symbols-outlined font-bold"
                >add_shopping_cart</span
              >
            </div>
            <div>
              <h2 class="text-base font-extrabold text-slate-900">
                New Purchase Request
              </h2>
              <p
                class="text-[10px] text-slate-500 font-bold uppercase tracking-widest"
              >
                General Procurement Form
              </p>
            </div>
          </div>
          <button
            id="closeCreateProductModal"
            class="size-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition-colors text-slate-400"
          >
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <form id="createProductForm" th:action="@{/product/save}" th:object="${product}" method="post" enctype="multipart/form-data">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <div class="p-6 space-y-5">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="form-label">Producto / Servicio</label>
              <input
                class="form-input"
                placeholder="p. ej. Monitor Dell UltraSharp 27 pulgadas"
                type="text"
                th:field="*{name}"
                th:classappend="${#fields.hasErrors('name')} ? 'border-rose-500' : ''"
              />
              <p th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="text-rose-600 text-xs mt-1"></p>
            </div>
            <div>
              <label class="form-label">Validador</label>
              <select class="form-input" id="validatorSelect" name="validatorId">
                <option value="" disabled selected>Seleccionar validador</option>
                <option th:each="friend : ${friends}" th:value="${friend.id}" th:text="${friend.name + ' ' + friend.paternalLastName}">Amigo</option>
              </select>
            </div>
            <div>
              <label class="form-label">Monto estimado</label>
              <div class="relative">
                <span
                  class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-sm"
                  >$</span
                >
                <input
                  class="form-input pl-7 border-primary/30 bg-primary/5 font-extrabold text-primary"
                  placeholder="0.00"
                  type="number"
                  step="0.01"
                  th:field="*{price}"
                  th:classappend="${#fields.hasErrors('price')} ? 'border-rose-500' : ''"
                />
                <p th:if="${#fields.hasErrors('price')}" th:errors="*{price}" class="text-rose-600 text-xs mt-1"></p>
              </div>
            </div>
            <!-- file input removed (replaced by drag/drop zone below) -->
            <!-- Descripción removida: no hay campo 'description' en el modelo Product -->
            <div
              class="md:col-span-2 bg-slate-50 p-4 rounded-xl border border-slate-100"
            >
              <label class="form-label mb-3">Plan de pago</label>
              <div class="flex flex-wrap items-center gap-6">
                <label class="flex items-center gap-2 cursor-pointer group">
                  <input
                    th:field="*{hasInstallments}"
                    id="hasInstallmentsCheckbox"
                    class="w-4 h-4 text-primary focus:ring-primary border-slate-300"
                    type="checkbox"
                  />
                  <span class="text-sm font-semibold text-slate-700">Pagos a plazos</span>
                </label>
                <div id="installmentsOptions" class="flex items-center gap-3 hidden">
                  <div class="flex items-center bg-white border border-slate-200 rounded-md px-2 py-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase mr-2">Cantidad:</span>
                    <input
                      th:field="*{installmentsCount}"
                      class="w-12 p-0 border-none text-xs font-bold text-slate-700 focus:ring-0"
                      max="24"
                      min="1"
                      type="number"
                      th:classappend="${#fields.hasErrors('installmentsCount')} ? 'border-rose-500' : ''"
                    />
                    <p th:if="${#fields.hasErrors('installmentsCount')}" th:errors="*{installmentsCount}" class="text-rose-600 text-xs mt-1"></p>
                  </div>
                  <div class="flex items-center bg-white border border-slate-200 rounded-md px-2 py-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase mr-2">Frecuencia:</span>
                    <select th:field="*{installmentFrequency}" class="form-input" th:classappend="${#fields.hasErrors('installmentFrequency')} ? 'border-rose-500' : ''">
                      <option value="monthly">Mensual</option>
                      <option value="biweekly">Quincenal</option>
                      <option value="weekly">Semanal</option>
                    </select>
                    <p th:if="${#fields.hasErrors('installmentFrequency')}" th:errors="*{installmentFrequency}" class="text-rose-600 text-xs mt-1"></p>
                  </div>
                </div>
              </div>
            </div>
            <div class="md:col-span-2">
              <label class="form-label">Imagen</label>
              <div
                id="attachmentDropzone"
                class="border-2 border-dashed border-slate-200 rounded-xl p-6 flex flex-col items-center justify-center bg-slate-50/30 hover:bg-slate-50 hover:border-primary/50 transition-all cursor-pointer"
              >
                <span
                  class="material-symbols-outlined text-slate-300 text-3xl mb-2"
                  >upload_file</span
                >
                <p
                  class="text-xs font-bold text-slate-500 uppercase tracking-wide"
                >
                  Arrastra y suelta archivos o
                  <span id="attachmentBrowse" class="text-primary">examinar</span>
                </p>
                <p id="attachmentFilename" class="text-sm text-slate-700 mt-2 hidden"></p>
                <p id="attachmentError" class="text-rose-600 text-xs mt-1 hidden"></p>
                <p class="text-[9px] text-slate-400 mt-1 uppercase">
                  PDF, PNG o JPG (Máx. 10MB)
                </p>
                <input id="attachmentInput" type="file" name="attachment" accept="image/png,image/jpeg,application/pdf" class="hidden" />
              </div>
            </div>
          </div>
        </div>
        <div
          class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex items-center justify-end gap-3"
        >
          <button
            id="cancelCreateProduct"
            type="button"
            class="px-5 py-2 text-xs font-bold text-slate-500 hover:text-slate-700 uppercase tracking-widest transition-colors"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="bg-primary text-white px-6 py-2 rounded-lg text-xs font-bold hover:bg-primary/90 transition-all shadow-lg shadow-primary/20 flex items-center gap-2 uppercase tracking-widest"
          >
            <span>Enviar para aprobación</span>
            <span class="material-symbols-outlined text-sm">send</span>
          </button>
        </div>
      </form>
      </div>
    </div>
    <script src="/js/loading.js"></script>
    <script>
      // Activate navigation link based on current path
      (function () {
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll(".nav-link");

        navLinks.forEach((link) => {
          const linkPath = link.getAttribute("data-path");
          if (linkPath === currentPath) {
            link.classList.add("active");
            link.classList.remove("no-active");
          } else {
            link.classList.add("no-active");
            link.classList.remove("active");
          }
        });
      })();
    </script>
    <script>
      // Hide modal immediately on form submit so loading can show
      (function(){
        var form = document.getElementById('createProductForm');
        if (!form) return;
        form.addEventListener('submit', function(){
          try {
            var modal = document.getElementById('createProductModal');
            var modalContent = document.getElementById('createProductModalContent');
            if (modal) {
              modal.classList.remove('animate-overlay');
              modal.style.display = 'none';
              modal.classList.add('hidden');
              modal.style.position = '';
              modal.style.top = '';
              modal.style.left = '';
              modal.style.width = '';
              modal.style.height = '';
            }
            if (modalContent) {
              modalContent.classList.remove('animate-pop-in');
              modalContent.style.maxHeight = '';
              modalContent.style.overflow = '';
            }
            // restore body scroll
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.right = '';
          } catch (e) {
            // silent
          }
        });
      })();
    </script>
    <script>
      // Drag & drop + click file picker for attachmentDropzone
      (function(){
        var drop = document.getElementById('attachmentDropzone');
        var fileInput = document.getElementById('attachmentInput');
        var browse = document.getElementById('attachmentBrowse');
        var filenameEl = document.getElementById('attachmentFilename');
        var errorEl = document.getElementById('attachmentError');
        if (!drop || !fileInput) return;

        var MAX = 10 * 1024 * 1024; // 10MB
        function clearError(){ if(errorEl){ errorEl.textContent=''; errorEl.classList.add('hidden'); } }
        function showError(msg){ if(errorEl){ errorEl.textContent = msg; errorEl.classList.remove('hidden'); } }
        function setFileDisplay(file){ if(!filenameEl) return; if(file){ filenameEl.textContent = file.name; filenameEl.classList.remove('hidden'); } else { filenameEl.classList.add('hidden'); filenameEl.textContent=''; } }

        drop.addEventListener('click', function(e){
          e.preventDefault();
          clearError();
          fileInput.click();
        });
        if (browse) browse.addEventListener('click', function(e){ e.stopPropagation(); fileInput.click(); });

        drop.addEventListener('dragover', function(e){ e.preventDefault(); drop.classList.add('border-primary'); drop.classList.add('bg-white'); });
        drop.addEventListener('dragleave', function(e){ e.preventDefault(); drop.classList.remove('border-primary'); drop.classList.remove('bg-white'); });
        drop.addEventListener('drop', function(e){
          e.preventDefault(); drop.classList.remove('border-primary'); drop.classList.remove('bg-white');
          clearError();
          var f = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) ? e.dataTransfer.files[0] : null;
          if (!f) return;
          if (f.size > MAX) { showError('El archivo debe ser menor a 10MB'); fileInput.value = ''; setFileDisplay(null); return; }
          var allowed = ['image/png','image/jpeg','application/pdf'];
          if (allowed.indexOf(f.type) === -1) { showError('Formato no soportado'); fileInput.value = ''; setFileDisplay(null); return; }
          try {
            var dt = new DataTransfer();
            dt.items.add(f);
            fileInput.files = dt.files;
            setFileDisplay(f);
          } catch(err){
            // fallback: can't programmatically set files in some browsers
            showError('No se pudo adjuntar el archivo automáticamente. Usa el selector.');
          }
        });

        fileInput.addEventListener('change', function(){
          clearError();
          var f = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
          if (!f) { setFileDisplay(null); return; }
          if (f.size > MAX) { showError('El archivo debe ser menor a 10MB'); fileInput.value = ''; setFileDisplay(null); return; }
          var allowed = ['image/png','image/jpeg','application/pdf'];
          if (allowed.indexOf(f.type) === -1) { showError('Formato no soportado'); fileInput.value = ''; setFileDisplay(null); return; }
          setFileDisplay(f);
        });
      })();
    </script>
    <script>
      // Modal open/close logic for Create Product
      (function () {
        const openBtn = document.getElementById("openCreateProductModal");
        const modal = document.getElementById("createProductModal");
        const modalContent = document.getElementById(
          "createProductModalContent",
        );
        const closeBtn = document.getElementById("closeCreateProductModal");
        const cancelBtn = document.getElementById("cancelCreateProduct");

        if (!openBtn || !modal) return;
        let _savedScrollY = 0;
        let _wasSmallScreen = false;

        function applyModalLayout() {
          const isSmall = window.innerWidth < 640;

          if (!isSmall) {
            // Large screens: prevent background scroll and make modal content scroll internally
            if (_wasSmallScreen) {
              // Transitioning from small to large: clean up small screen styles
              modal.style.position = "";
              modal.style.top = "";
              modal.style.left = "";
              modal.style.width = "";
              modal.style.height = "";
            }

            if (document.body.style.position !== "fixed") {
              _savedScrollY = window.scrollY || window.pageYOffset || 0;
              document.body.style.position = "fixed";
              document.body.style.top = -_savedScrollY + "px";
              document.body.style.left = "0";
              document.body.style.right = "0";
              document.body.style.overflow = "hidden";
            }

            modal.style.pointerEvents = "auto";
            if (modalContent) {
              modalContent.style.maxHeight = "calc(100vh - 4rem)";
              modalContent.style.overflowY = "auto";
              modalContent.style.webkitOverflowScrolling = "touch";
            }
          } else {
            // Small screens: position modal absolute at current scroll, allow page to scroll
            if (!_wasSmallScreen) {
              // Transitioning from large to small: restore body scroll
              document.body.style.overflow = "";
              document.body.style.position = "";
              document.body.style.top = "";
              document.body.style.left = "";
              document.body.style.right = "";
              if (_savedScrollY) {
                window.scrollTo(0, _savedScrollY);
              }
            }

            modal.style.position = "absolute";
            modal.style.top = "0";
            modal.style.left = "0";
            modal.style.width = "100%";
            // Ensure overlay covers the entire document height
            const docHeight = Math.max(
              document.body.scrollHeight,
              document.documentElement.scrollHeight,
              document.body.offsetHeight,
              document.documentElement.offsetHeight,
            );
            modal.style.height = docHeight + "px";
            modal.style.pointerEvents = "auto";
            // Let modal content flow naturally without maxHeight/overflow restrictions
            if (modalContent) {
              modalContent.style.maxHeight = "none";
              modalContent.style.overflow = "visible";
              modalContent.style.pointerEvents = "auto";
            }
          }

          _wasSmallScreen = isSmall;
        }

        function openModal() {
          modal.classList.remove("hidden");
          modal.style.display = "flex";
          // trigger overlay and content animations
          modal.classList.remove("animate-overlay");
          void modal.offsetWidth;
          modal.classList.add("animate-overlay");

          if (modalContent) {
            modalContent.classList.remove("animate-pop-in");
            void modalContent.offsetWidth;
            modalContent.classList.add("animate-pop-in");
          }

          _savedScrollY = window.scrollY || window.pageYOffset || 0;
          _wasSmallScreen = window.innerWidth < 640;
          applyModalLayout();
        }

        function closeModal() {
          // remove animation classes and hide
          modal.classList.remove("animate-overlay");
          if (modalContent) modalContent.classList.remove("animate-pop-in");
          modal.style.display = "none";
          modal.classList.add("hidden");
          // restore body scroll and cleanup inline styles
          document.body.style.overflow = "";
          document.body.style.position = "";
          document.body.style.top = "";
          document.body.style.left = "";
          document.body.style.right = "";
          // restore page scroll position
          if (_savedScrollY) {
            window.scrollTo(0, _savedScrollY);
          }
          _savedScrollY = 0;
          _wasSmallScreen = false;
          // reset any positioning
          modal.style.position = "";
          modal.style.top = "";
          modal.style.left = "";
          modal.style.width = "";
          modal.style.height = "";
          modal.style.minHeight = "";
          modal.style.pointerEvents = "";
          if (modalContent) {
            modalContent.style.maxHeight = "";
            modalContent.style.overflow = "";
            modalContent.style.pointerEvents = "";
          }
        }

        openBtn.addEventListener("click", function (e) {
          e.preventDefault();
          openModal();
        });

        if (closeBtn) closeBtn.addEventListener("click", closeModal);
        if (cancelBtn) cancelBtn.addEventListener("click", closeModal);

        // Close on overlay click
        modal.addEventListener("click", function (e) {
          if (e.target === modal) closeModal();
        });

        // Close on ESC
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape" && !modal.classList.contains("hidden"))
            closeModal();
        });

        // Handle window resize while modal is open
        window.addEventListener("resize", function () {
          if (!modal.classList.contains("hidden")) {
            applyModalLayout();
          }
        });
      })();
    </script>
    <script>
      // Toggle installments options when checkbox changes
      (function () {
        const cb = document.getElementById('hasInstallmentsCheckbox') || document.querySelector('input[name="hasInstallments"]');
        const opts = document.getElementById('installmentsOptions');
        if (!cb || !opts) return;
        function update() {
          if (cb.checked) opts.classList.remove('hidden');
          else opts.classList.add('hidden');
        }
        cb.addEventListener('change', update);
        // initial state
        update();
      })();
    </script>
  </body>
  <script>
    (function () {
      const btn = document.getElementById("userMenuButton");
      const menu = document.getElementById("userMenu");
      const toggle = document.getElementById("userMenuToggle");
      const wrapper = document.getElementById("userMenuWrapper");
      const avatar = document.getElementById("userAvatar");
      if (!btn || !menu) return;

      function closeMenu() {
        menu.classList.add("hidden");
        menu.classList.remove("dropdown-enter");
        btn.setAttribute("aria-expanded", "false");
        if (avatar) avatar.setAttribute("aria-expanded", "false");
      }

      function openMenu() {
        menu.classList.remove("hidden");
        // Forzar reflow para que la animación funcione
        menu.offsetHeight;
        menu.classList.add("dropdown-enter");
        btn.setAttribute("aria-expanded", "true");
        if (avatar) avatar.setAttribute("aria-expanded", "true");
      }

      function toggleMenu(e) {
        e.stopPropagation();
        if (menu.classList.contains("hidden")) openMenu();
        else closeMenu();
      }

      btn.addEventListener("click", toggleMenu);

      // Make the name/role area toggle the menu as well (visible on sm+)
      if (toggle) {
        toggle.addEventListener("click", toggleMenu);
        toggle.addEventListener("keydown", function (e) {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            toggleMenu(e);
          }
        });
      }

      // Also allow clicking the avatar/wrapper to open menu (useful on mobile)
      if (wrapper) {
        wrapper.addEventListener("click", function (e) {
          // if the click was on the expand button, let that handler run
          if (e.target.closest("#userMenuButton")) return;
          toggleMenu(e);
        });
        wrapper.addEventListener("keydown", function (e) {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            toggleMenu(e);
          }
        });
      } else if (avatar) {
        avatar.addEventListener("click", toggleMenu);
        avatar.addEventListener("keydown", function (e) {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            toggleMenu(e);
          }
        });
      }

      // Close on outside click
      document.addEventListener("click", function () {
        closeMenu();
      });

      // Close on ESC
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") closeMenu();
      });
    })();
  </script>
</html>
